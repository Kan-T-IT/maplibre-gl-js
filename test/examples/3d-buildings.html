<!DOCTYPE html>
<html lang="en">
<head>
  <title>Display buildings in 3D</title>
  <meta property="og:description" content="Use extrusions to display buildings' height in 3D." />
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel='stylesheet' href='../../dist/maplibre-gl.css' />
  <script src='../../dist/maplibre-gl-dev.js'></script>
  <style>
      body { margin: 0; padding: 0; }
      html, body, #map { height: 100%; }
      #enter-ar {
          position: absolute;
          top: 10px;
          left: 10px;
          z-index: 1;
          padding: 10px;
          background-color: #fff;
          border: 1px solid #ccc;
          border-radius: 5px;
          cursor: pointer;
      }
      #enter-ar:hover {
          background-color: #c9c9c9;
      }
  </style>
</head>
<body>
<div id="map"></div>
<button id="enter-ar" onclick="webXRInitialize();">Enter AR</button>
<script>

async function webXRInitialize() {
    const gl = maplibreMap.painter.context.gl;
    if (!gl) {
        console.error('WebGL2 not supported');
        return false;
    }
    try {
        const xr = navigator.xr;
        if (!xr) {
            console.error('No WebXR support found');
            return false;
        } else {
            xr.addEventListener('devicechange', (event) => {
                console.log('devicechange', event);
            });

            const isInlineSupported = await xr.isSessionSupported('inline');
            const isVrSupported = await xr.isSessionSupported('immersive-vr');
            const isArSupported = await xr.isSessionSupported('immersive-ar');
            console.log('isInlineSupported', isInlineSupported);
            console.log('isVrSupported', isVrSupported);
            console.log('isArSupported', isArSupported);

            const sessionType = isArSupported ? 'immersive-ar' : isVrSupported ? 'immersive-vr' : isInlineSupported ? 'inline' : null;
            console.log('sessionType', sessionType);
            if (!sessionType) throw new Error('No sessionType found');
            const session = await xr.requestSession(sessionType).catch((err) => {
                console.error('Error requestSession', err);
            });

            if (!session) throw new Error('No session found');

            console.log('WebXR - session', session, gl);
            await session.updateRenderState({
                baseLayer: new XRWebGLLayer(session, gl)
            });

            // A 'local' reference space has a native origin that is located
            // near the viewer's position at the time the session was created.
            const referenceSpace = await session.requestReferenceSpace('local').catch((err) => {
                console.error('Error requestReferenceSpace', err);
                throw err;
            });

            console.log('WebXR - initialized');

            const webXR = {
                session,
                referenceSpace
            };
            window.webXR = webXR;

            console.log('session.renderState.baseLayer', session.renderState.baseLayer);
            maplibreMap.triggerRepaint(session.requestAnimationFrame.bind(session));
            // const glLayer = frame.session.renderState.baseLayer;
            // gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);
            // maplibreMap.painter.context.setViewFramebuffer(glLayer.framebuffer);
            return webXR;
        }
    } catch (err) {
        console.error('WebXR - Error initialize', err);
        return false;
    }
}

</script>
<script>
    (async function init() {
        const MAPTILER_KEY = 'get_your_own_OpIi9ZULNHzrESv6T2vL';
        console.log(maplibregl);
        window.maplibreMap = new maplibregl.Map({
            style: `https://api.maptiler.com/maps/basic-v2/style.json?key=${MAPTILER_KEY}`,
            center: [-74.0066, 40.7135],
            zoom: 15.5,
            pitch: 45,
            bearing: -17.6,
            container: 'map',
            antialias: true,
        });
        maplibreMap.showOverdrawInspector = true;

        // The 'building' layer in the streets vector source contains building-height
        // data from OpenStreetMap.
        maplibreMap.on('load', () => {
            // Insert the layer beneath any symbol layer.
            const layers = maplibreMap.getStyle().layers;

            let labelLayerId;
            for (let i = 0; i < layers.length; i++) {
                if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                    labelLayerId = layers[i].id;
                    break;
                }
            }

            maplibreMap.addSource('openmaptiles', {
                url: `https://api.maptiler.com/tiles/v3/tiles.json?key=${MAPTILER_KEY}`,
                type: 'vector',
            });

            maplibreMap.addLayer(
                {
                    'id': '3d-buildings',
                    'source': 'openmaptiles',
                    'source-layer': 'building',
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': [
                            'interpolate',
                            ['linear'],
                            ['get', 'render_height'], 0, 'lightgray', 200, 'royalblue', 400, 'lightblue'
                        ],
                        'fill-extrusion-height': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            15,
                            0,
                            16,
                            ['get', 'render_height']
                        ],
                        'fill-extrusion-base': ['case',
                            ['>=', ['get', 'zoom'], 16],
                            ['get', 'render_min_height'], 0
                        ]
                    }
                },
                labelLayerId
            );

        });
    })();
</script>
</body>
</html>